define(["jquery","moment","lokijs","charts/chartingRequestMap","websockets/stream_handler","datatables"],function(a,b,c,d,e){function f(c){var f=c.find(".table-view"),g=c.find("#"+c.attr("id")+"_chart").data(),j=isTick(g.timePeriod),l=d.keyFor(g.instrumentCode,g.timePeriod),m=c.find("span.close");m.on("click",i.bind(null,c));var n=a("<table width='100%' class='portfolio-dialog display compact'/>");n.appendTo(f);var o=[{title:"Date",orderable:!1,render:function(a){return b.utc(a).format("YYYY-MM-DD HH:mm:ss")}},{title:"Open",orderable:!1},{title:"High",orderable:!1},{title:"Low",orderable:!1},{title:"Close",orderable:!1},{title:"Change",orderable:!1},{title:"",orderable:!1}],p=[0,1,2,3,4,5];j&&(o=[{title:"Date",orderable:!1,render:function(a){return b.utc(a).format("YYYY-MM-DD HH:mm:ss")}},{title:"Tick",orderable:!1},{title:"Change",orderable:!1},{title:"",orderable:!1}],p=[0,1,2]),n=n.dataTable({data:[],columns:o,paging:!1,ordering:!0,info:!1,order:[0,"desc"],columnDefs:[{className:"dt-head-center dt-body-center",targets:p}]}),n.parent().addClass("hide-search-input");var q=e.events.on("tick",function(a){if(a.key===l&&c.view_table_visible){var b=a.tick,d=k(a.preTick.open,b.open),e=[b.time,b.open,d.value,d.image];n.api().row.add(e),n.api().draw()}}),r=e.events.on("ohlc",function(a){if(a.key===l&&c.view_table_visible){var b=a.ohlc,d=k(a.preOhlc.close,b.close),e=[b.time,b.open,b.high,b.low,b.close,d.value,d.image];a.is_new?n.api().row.add(e):n.api().row(0).data(e),n.api().draw()}});return c.on("dialogdestroy",function(){e.events.off("tick",q),e.events.off("ohld",r)}),{show:h.bind(null,c,l),hide:i.bind(null,c)}}var g=d.barsTable,h=function(a,b){var c=a.find(".table-view"),d=a.find(".chart-view");a.find("span.close").css("display","block"),c.animate({left:"0"},250),d.animate({left:"-100%"},250),j(a,b);var e=a.dialog("option","width"),f=a.find("#"+a.attr("id")+"_chart").data(),g=isTick(f.timePeriod)?500:700;g>e&&(a.dialog("option","minWidth",e),a.dialog("option","width",g));var h=c.find("table").DataTable();h.columns.adjust().draw(),a.view_table_visible=!0},i=function(a){var b=a.find(".table-view"),c=a.find(".chart-view");a.find("span.close").css("display","none"),b.animate({left:"100%"},250),c.animate({left:"0"},250),a.view_table_visible=!1;var d=a.dialog("option","minWidth");if(a.parent().width()!==d){a.dialog("option","width",d),a.dialog("option","minWidth",350);var e=a.find(".chartSubContainer");e.width(a.width()-10),e.height(a.height()-15);var f="#"+e.attr("id");require(["charts/charts"],function(a){a.triggerReflow(f)})}},j=function(a,b){var c=a.find("#"+a.attr("id")+"_chart").data(),d=isTick(c.timePeriod),e=a.find(".table-view"),f=g.chain().find({instrumentCdAndTp:b}).simplesort("time",!0).data(),h=0,i=f.map(function(a){var b=h==f.length-1?f[h]:f[h+1];if(h++,d){var c=k(b.open,a.open);return[a.time,a.open,c.value,c.image]}var c=k(b.close,a.close);return[a.time,a.open,a.high,a.low,a.close,c.value,c.image]}),j=e.find("table").DataTable();j.rows().remove(),j.rows.add(i),j.draw()},k=function(a,b){var c=toFixed(Math.abs(a-b),4),d=toFixed(Math.abs(a-b)/Math.abs(a)*100,2);return b>=a?{value:c+"("+d+"%)",image:0===c?"":'<img src="images/green_up_arrow.svg" class="arrow-images"/>'}:{value:'<span style="color:brown">'+c+"("+d+"%) </span>",image:0===c?"":'<img src="images/red_down_arrow.svg" class="arrow-images"/>'}};return{init:f}});